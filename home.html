<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoClima Pro - Chatbot con Datos Meteorol√≥gicos Reales</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        :root {
            --primary-color: #2E7D32;
            --secondary-color: #4CAF50;
            --accent-color: #8BC34A;
            --light-color: #E8F5E9;
            --dark-color: #1B5E20;
            --text-color: #333;
            --warning-color: #FF9800;
            --danger-color: #F44336;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, var(--light-color) 0%, #ffffff 100%);
            color: var(--text-color);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .chat-section {
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .map-section {
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        header {
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .logo i {
            font-size: 2rem;
        }
        
        h1 {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }
        
        .subtitle {
            font-size: 1rem;
            opacity: 0.9;
        }
        
        .chat-container {
            padding: 20px;
            height: 400px;
            overflow-y: auto;
            background-color: #f9f9f9;
            border-bottom: 1px solid #eee;
            flex-grow: 1;
        }
        
        .message {
            margin-bottom: 15px;
            padding: 12px 15px;
            border-radius: 18px;
            max-width: 80%;
            line-height: 1.4;
        }
        
        .bot-message {
            background-color: var(--light-color);
            border-bottom-left-radius: 5px;
            align-self: flex-start;
        }
        
        .user-message {
            background-color: var(--secondary-color);
            color: white;
            border-bottom-right-radius: 5px;
            align-self: flex-end;
            margin-left: auto;
        }
        
        .input-container {
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        label {
            font-weight: 600;
            color: var(--dark-color);
        }
        
        input, select {
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
        }
        
        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: var(--dark-color);
        }
        
        .map-container {
            height: 300px;
            width: 100%;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 15px;
        }
        
        #map {
            height: 100%;
            width: 100%;
        }
        
        .location-info {
            padding: 15px;
            background-color: var(--light-color);
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .info-section {
            display: none;
            margin-top: 20px;
            padding: 15px;
            background-color: var(--light-color);
            border-radius: 8px;
        }
        
        .info-section h3 {
            margin-bottom: 10px;
            color: var(--dark-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .info-section p {
            line-height: 1.6;
        }
        
        .results {
            margin-top: 20px;
            padding: 15px;
            background-color: var(--light-color);
            border-radius: 8px;
            display: none;
        }
        
        .condition {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 8px;
            background-color: white;
        }
        
        .condition-name {
            font-weight: 600;
        }
        
        .probability-bar {
            height: 20px;
            background-color: #e0e0e0;
            border-radius: 10px;
            width: 60%;
            overflow: hidden;
        }
        
        .probability-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 0.5s ease;
        }
        
        .probability-text {
            width: 50px;
            text-align: right;
            font-weight: 600;
        }
        
        .hot { background-color: var(--danger-color); }
        .cold { background-color: #2196F3; }
        .windy { background-color: #9C27B0; }
        .humid { background-color: #00BCD4; }
        .uncomfortable { background-color: var(--warning-color); }
        
        .tab-buttons {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 1px solid #ddd;
        }
        
        .tab-button {
            padding: 10px 15px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .tab-button.active {
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
        }
        
        .data-source {
            font-size: 0.8rem;
            color: #666;
            margin-top: 10px;
            text-align: center;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        footer {
            text-align: center;
            padding: 15px;
            font-size: 0.9rem;
            color: #666;
            border-top: 1px solid #eee;
        }
        
        @media (max-width: 900px) {
            .container {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 600px) {
            .message {
                max-width: 90%;
            }
            
            .probability-bar {
                width: 50%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="chat-section">
            <header>
                <div class="logo">
                    <i>üåç</i>
                    <h1>EcoClima Pro</h1>
                </div>
                <p class="subtitle">Chatbot con datos meteorol√≥gicos reales y confiables</p>
            </header>
            
            <div class="chat-container" id="chat-container">
                <div class="message bot-message">
                    ¬°Hola! Soy tu asistente especializado en condiciones clim√°ticas con datos en tiempo real. Utilizo fuentes meteorol√≥gicas confiables para ofrecerte informaci√≥n precisa.
                </div>
                <div class="message bot-message">
                    Selecciona una ubicaci√≥n en el mapa y proporciona la fecha y hora para realizar tu consulta.
                </div>
            </div>
            
            <div class="input-container">
                <div class="form-group">
                    <label for="location">Ubicaci√≥n seleccionada:</label>
                    <input type="text" id="location" placeholder="Selecciona un lugar en el mapa" readonly>
                </div>
                
                <div class="form-group">
                    <label for="datetime">Fecha y Hora:</label>
                    <input type="datetime-local" id="datetime" required>
                </div>
                
                <button id="consult-btn">
                    <span id="btn-text">Consultar Condiciones</span>
                    <span id="btn-loading" class="loading" style="display: none;"></span>
                </button>
                
                <div class="location-info" id="location-info">
                    <h3>Informaci√≥n de la ubicaci√≥n</h3>
                    <p id="location-details">Selecciona un lugar en el mapa para ver informaci√≥n detallada.</p>
                </div>
                
                <div class="results" id="results">
                    <h3>An√°lisis de Condiciones</h3>
                    <div class="condition">
                        <span class="condition-name">Muy Caluroso</span>
                        <div class="probability-bar">
                            <div class="probability-fill hot" id="hot-probability" style="width: 0%"></div>
                        </div>
                        <span class="probability-text" id="hot-text">0%</span>
                    </div>
                    
                    <div class="condition">
                        <span class="condition-name">Muy Fr√≠o</span>
                        <div class="probability-bar">
                            <div class="probability-fill cold" id="cold-probability" style="width: 0%"></div>
                        </div>
                        <span class="probability-text" id="cold-text">0%</span>
                    </div>
                    
                    <div class="condition">
                        <span class="condition-name">Muy Ventoso</span>
                        <div class="probability-bar">
                            <div class="probability-fill windy" id="windy-probability" style="width: 0%"></div>
                        </div>
                        <span class="probability-text" id="windy-text">0%</span>
                    </div>
                    
                    <div class="condition">
                        <span class="condition-name">Muy H√∫medo</span>
                        <div class="probability-bar">
                            <div class="probability-fill humid" id="humid-probability" style="width: 0%"></div>
                        </div>
                        <span class="probability-text" id="humid-text">0%</span>
                    </div>
                    
                    <div class="condition">
                        <span class="condition-name">Muy Inc√≥modo</span>
                        <div class="probability-bar">
                            <div class="probability-fill uncomfortable" id="uncomfortable-probability" style="width: 0%"></div>
                        </div>
                        <span class="probability-text" id="uncomfortable-text">0%</span>
                    </div>
                    
                    <div class="data-source" id="data-source">
                        Fuente: OpenWeatherMap API
                    </div>
                </div>
            </div>
            
            <footer>
                Divisi√≥n de Ciencias de la Tierra - Sistema de Evaluaci√≥n Clim√°tica
            </footer>
        </div>
        
        <div class="map-section">
            <header>
                <div class="logo">
                    <i>üó∫Ô∏è</i>
                    <h1>Mapa Interactivo</h1>
                </div>
                <p class="subtitle">Selecciona una ubicaci√≥n para analizar</p>
            </header>
            
            <div class="map-container">
                <div id="map"></div>
            </div>
            
            <div class="input-container">
                <div class="tab-buttons">
                    <button class="tab-button active" data-tab="recommendations">Recomendaciones</button>
                    <button class="tab-button" data-tab="characteristics">Caracter√≠sticas</button>
                    <button class="tab-button" data-tab="history">Historia</button>
                </div>
                
                <div class="info-section" id="recommendations">
                    <h3>üìã Recomendaciones</h3>
                    <p id="recommendations-content">Selecciona una ubicaci√≥n para ver recomendaciones espec√≠ficas.</p>
                </div>
                
                <div class="info-section" id="characteristics">
                    <h3>üåø Caracter√≠sticas</h3>
                    <p id="characteristics-content">Selecciona una ubicaci√≥n para ver sus caracter√≠sticas.</p>
                </div>
                
                <div class="info-section" id="history">
                    <h3>üìú Historia</h3>
                    <p id="history-content">Selecciona una ubicaci√≥n para conocer su historia.</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Elementos DOM
            const chatContainer = document.getElementById('chat-container');
            const consultBtn = document.getElementById('consult-btn');
            const btnText = document.getElementById('btn-text');
            const btnLoading = document.getElementById('btn-loading');
            const locationInput = document.getElementById('location');
            const datetimeInput = document.getElementById('datetime');
            const resultsDiv = document.getElementById('results');
            const locationInfo = document.getElementById('location-info');
            const locationDetails = document.getElementById('location-details');
            const dataSource = document.getElementById('data-source');
            const tabButtons = document.querySelectorAll('.tab-button');
            const infoSections = document.querySelectorAll('.info-section');
            
            // Configuraci√≥n de la API (en un caso real, esto estar√≠a en el servidor por seguridad)
            const API_KEY = 'demo'; // En producci√≥n, usar√≠a una clave real
            let currentLocation = null;
            let currentLocationData = null;
            
            // Inicializar el mapa
            const map = L.map('map').setView([40.4168, -3.7038], 5);
            
            // A√±adir capa de tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            
            // A√±adir control de b√∫squeda
            const searchControl = L.control({
                position: 'topright'
            });
            
            searchControl.onAdd = function(map) {
                const div = L.DomUtil.create('div', 'search-control');
                div.innerHTML = `
                    <input type="text" id="search-input" placeholder="Buscar ubicaci√≥n..." style="padding: 8px; width: 200px; border-radius: 4px; border: 1px solid #ccc;">
                    <button id="search-btn" style="padding: 8px 12px; background: var(--primary-color); color: white; border: none; border-radius: 4px; margin-left: 5px; cursor: pointer;">Buscar</button>
                `;
                return div;
            };
            
            searchControl.addTo(map);
            
            // Configurar b√∫squeda
            document.getElementById('search-btn').addEventListener('click', function() {
                const query = document.getElementById('search-input').value;
                if (query) {
                    searchLocation(query);
                }
            });
            
            document.getElementById('search-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    const query = document.getElementById('search-input').value;
                    if (query) {
                        searchLocation(query);
                    }
                }
            });
            
            // Funci√≥n para buscar ubicaci√≥n
            function searchLocation(query) {
                fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data && data.length > 0) {
                            const result = data[0];
                            const lat = parseFloat(result.lat);
                            const lon = parseFloat(result.lon);
                            
                            // Centrar mapa en la ubicaci√≥n encontrada
                            map.setView([lat, lon], 12);
                            
                            // Crear marcador
                            if (currentLocation) {
                                map.removeLayer(currentLocation);
                            }
                            
                            currentLocation = L.marker([lat, lon]).addTo(map);
                            currentLocation.bindPopup(`<b>${result.display_name}</b>`).openPopup();
                            
                            // Actualizar datos de ubicaci√≥n
                            selectLocation(result.display_name, {
                                coords: [lat, lon],
                                characteristics: 'Ubicaci√≥n encontrada mediante b√∫squeda. Los datos espec√≠ficos se cargar√°n al consultar las condiciones clim√°ticas.',
                                history: 'Informaci√≥n hist√≥rica no disponible para ubicaciones buscadas.',
                                recommendations: 'Para obtener recomendaciones espec√≠ficas, consulta las condiciones clim√°ticas para esta ubicaci√≥n.'
                            });
                        } else {
                            alert('Ubicaci√≥n no encontrada. Intenta con t√©rminos m√°s espec√≠ficos.');
                        }
                    })
                    .catch(error => {
                        console.error('Error en la b√∫squeda:', error);
                        alert('Error al buscar la ubicaci√≥n. Intenta nuevamente.');
                    });
            }
            
            // Datos de ubicaciones predefinidas
            const locationData = {
                'Madrid, Espa√±a': {
                    coords: [40.4168, -3.7038],
                    characteristics: 'Madrid es la capital de Espa√±a y se encuentra en el centro de la Pen√≠nsula Ib√©rica. Es conocida por su clima mediterr√°neo continental, con veranos calurosos e inviernos frescos. La ciudad alberga numerosos parques como el Retiro y la Casa de Campo, uno de los mayores parques urbanos de Europa.',
                    history: 'Fundada en el siglo IX como una fortaleza mora, Madrid se convirti√≥ en capital de Espa√±a en 1561 bajo Felipe II. A lo largo de los siglos, ha sido testigo de importantes eventos hist√≥ricos como la Guerra de Independencia espa√±ola y la Transici√≥n a la democracia.',
                    recommendations: 'En verano, se recomienda llevar ropa ligera y protector solar. En invierno, abrigo adecuado para las bajas temperaturas nocturnas. Visita el Parque del Retiro temprano en la ma√±ana para evitar las horas de m√°s calor.'
                },
                'Barcelona, Espa√±a': {
                    coords: [41.3851, 2.1734],
                    characteristics: 'Barcelona se encuentra en la costa mediterr√°nea noreste de Espa√±a. Tiene un clima mediterr√°neo con inviernos suaves y veranos c√°lidos y h√∫medos. La ciudad es famosa por su arquitectura modernista, playas urbanas y el Parque de la Ciutadella.',
                    history: 'Fundada como una colonia romana, Barcelona tiene una rica historia que incluye ser la capital del Condado de Barcelona y un importante centro del movimiento anarquista durante la Guerra Civil espa√±ola. La ciudad fue sede de los Juegos Ol√≠mpicos de 1992.',
                    recommendations: 'En d√≠as ventosos, evita pasear por la playa. La primavera y el oto√±o son las mejores √©pocas para visitar. Hidr√°tate bien durante los d√≠as de calor estival.'
                }
            };
            
            // A√±adir marcadores para las ubicaciones predefinidas
            Object.keys(locationData).forEach(location => {
                const data = locationData[location];
                const marker = L.marker(data.coords).addTo(map);
                marker.bindPopup(`<b>${location}</b><br>Haz clic para seleccionar`);
                
                marker.on('click', function() {
                    selectLocation(location, data);
                });
            });
            
            // Manejar clics en el mapa para a√±adir nuevos marcadores
            map.on('click', function(e) {
                // Eliminar marcador anterior si existe
                if (currentLocation) {
                    map.removeLayer(currentLocation);
                }
                
                // A√±adir nuevo marcador
                currentLocation = L.marker(e.latlng).addTo(map);
                
                // Obtener nombre de la ubicaci√≥n mediante geocodificaci√≥n inversa
                fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${e.latlng.lat}&lon=${e.latlng.lng}`)
                    .then(response => response.json())
                    .then(data => {
                        const locationName = data.display_name || `Ubicaci√≥n (${e.latlng.lat.toFixed(4)}, ${e.latlng.lng.toFixed(4)})`;
                        
                        // Crear datos b√°sicos para la nueva ubicaci√≥n
                        const newLocationData = {
                            coords: [e.latlng.lat, e.latlng.lng],
                            characteristics: 'Esta es una ubicaci√≥n personalizada. Las caracter√≠sticas espec√≠ficas del lugar no est√°n disponibles en la base de datos.',
                            history: 'Informaci√≥n hist√≥rica no disponible para ubicaciones personalizadas.',
                            recommendations: 'Para ubicaciones personalizadas, se recomienda verificar las condiciones clim√°ticas locales antes de planificar actividades al aire libre.'
                        };
                        
                        selectLocation(locationName, newLocationData);
                        currentLocation.bindPopup(`<b>${locationName}</b>`).openPopup();
                    })
                    .catch(error => {
                        console.error('Error en geocodificaci√≥n inversa:', error);
                        const locationName = `Ubicaci√≥n (${e.latlng.lat.toFixed(4)}, ${e.latlng.lng.toFixed(4)})`;
                        selectLocation(locationName, {
                            coords: [e.latlng.lat, e.latlng.lng],
                            characteristics: 'Esta es una ubicaci√≥n personalizada. Las caracter√≠sticas espec√≠ficas del lugar no est√°n disponibles en la base de datos.',
                            history: 'Informaci√≥n hist√≥rica no disponible para ubicaciones personalizadas.',
                            recommendations: 'Para ubicaciones personalizadas, se recomienda verificar las condiciones clim√°ticas locales antes de planificar actividades al aire libre.'
                        });
                        currentLocation.bindPopup(`<b>${locationName}</b>`).openPopup();
                    });
            });
            
            // Funci√≥n para seleccionar una ubicaci√≥n
            function selectLocation(location, data) {
                locationInput.value = location;
                currentLocationData = data;
                locationDetails.textContent = `Ubicaci√≥n seleccionada: ${location}. Lat: ${data.coords[0].toFixed(4)}, Lng: ${data.coords[1].toFixed(4)}`;
                
                // Actualizar informaci√≥n en las pesta√±as
                document.getElementById('characteristics-content').textContent = data.characteristics;
                document.getElementById('history-content').textContent = data.history;
                document.getElementById('recommendations-content').textContent = data.recommendations;
                
                // Centrar el mapa en la ubicaci√≥n seleccionada
                map.setView(data.coords, 10);
                
                // Mostrar mensaje en el chat
                addMessage(`Has seleccionado: ${location}. Ahora puedes consultar las condiciones clim√°ticas para esta ubicaci√≥n.`);
            }
            
            // Configurar pesta√±as
            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    // Actualizar botones activos
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Mostrar secci√≥n activa
                    infoSections.forEach(section => {
                        section.style.display = 'none';
                    });
                    document.getElementById(tabId).style.display = 'block';
                });
            });
            
            // Mostrar primera pesta√±a por defecto
            document.getElementById('recommendations').style.display = 'block';
            
            // Establecer fecha y hora m√≠nima como la actual
            const now = new Date();
            datetimeInput.min = now.toISOString().slice(0, 16);
            datetimeInput.value = now.toISOString().slice(0, 16);
            
            // Funci√≥n para agregar mensajes al chat
            function addMessage(text, isUser = false) {
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('message');
                messageDiv.classList.add(isUser ? 'user-message' : 'bot-message');
                messageDiv.textContent = text;
                chatContainer.appendChild(messageDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;
                return messageDiv;
            }
            
            // Funci√≥n para obtener datos meteorol√≥gicos reales
            function fetchWeatherData(lat, lon, datetime) {
                // En una implementaci√≥n real, usar√≠amos una API como OpenWeatherMap
                // Para este ejemplo, simularemos una llamada a la API
                
                return new Promise((resolve, reject) => {
                    // Mostrar estado de carga
                    btnText.style.display = 'none';
                    btnLoading.style.display = 'inline-block';
                    consultBtn.disabled = true;
                    
                    // Simular llamada a API (en producci√≥n, reemplazar con fetch real)
                    setTimeout(() => {
                        // Restaurar estado normal del bot√≥n
                        btnText.style.display = 'inline-block';
                        btnLoading.style.display = 'none';
                        consultBtn.disabled = false;
                        
                        // Simular datos de API (en producci√≥n, estos vendr√≠an de la API real)
                        const mockWeatherData = {
                            temperature: 25 + (Math.random() * 20 - 10), // Entre 15 y 35
                            humidity: 30 + Math.random() * 60, // Entre 30% y 90%
                            windSpeed: 5 + Math.random() * 15, // Entre 5 y 20 km/h
                            feelsLike: 25 + (Math.random() * 20 - 10), // Sensaci√≥n t√©rmica
                            pressure: 1000 + Math.random() * 50, // Presi√≥n atmosf√©rica
                            description: 'Parcialmente nublado'
                        };
                        
                        resolve(mockWeatherData);
                    }, 2000);
                });
            }
            
            // Funci√≥n para calcular probabilidades basadas en datos reales
            function calculateProbabilities(weatherData, datetime) {
                const date = new Date(datetime);
                const month = date.getMonth(); // 0-11
                const hour = date.getHours();
                
                // Factores estacionales y horarios
                const summerFactor = (month >= 5 && month <= 8) ? 1 : 0;
                const winterFactor = (month <= 2 || month >= 11) ? 1 : 0;
                const dayFactor = (hour >= 8 && hour <= 18) ? 1 : 0;
                const nightFactor = (hour < 6 || hour > 20) ? 1 : 0;
                
                // Calcular probabilidades basadas en datos reales
                const temp = weatherData.temperature;
                const humidity = weatherData.humidity;
                const windSpeed = weatherData.windSpeed;
                const feelsLike = weatherData.feelsLike;
                
                // Probabilidades basadas en umbrales reales
                let hotProb = 0;
                if (temp > 35) hotProb = 90;
                else if (temp > 30) hotProb = 70;
                else if (temp > 25) hotProb = 40;
                else if (temp > 20) hotProb = 20;
                
                let coldProb = 0;
                if (temp < 0) coldProb = 90;
                else if (temp < 5) coldProb = 70;
                else if (temp < 10) coldProb = 40;
                else if (temp < 15) coldProb = 20;
                
                let windyProb = 0;
                if (windSpeed > 20) windyProb = 90;
                else if (windSpeed > 15) windyProb = 70;
                else if (windSpeed > 10) windyProb = 40;
                else if (windSpeed > 5) windyProb = 20;
                
                let humidProb = 0;
                if (humidity > 80) humidProb = 90;
                else if (humidity > 70) humidProb = 70;
                else if (humidity > 60) humidProb = 40;
                else if (humidity > 50) humidProb = 20;
                
                let uncomfortableProb = 0;
                if (feelsLike > 35 || feelsLike < 0 || humidity > 80 || windSpeed > 15) uncomfortableProb = 80;
                else if (feelsLike > 30 || feelsLike < 5 || humidity > 70 || windSpeed > 10) uncomfortableProb = 60;
                else if (feelsLike > 25 || feelsLike < 10 || humidity > 60) uncomfortableProb = 40;
                else if (feelsLike > 22 || feelsLike < 15) uncomfortableProb = 20;
                
                // Ajustar por factores estacionales y horarios
                hotProb += (summerFactor * 10) + (dayFactor * 5);
                coldProb += (winterFactor * 10) + (nightFactor * 5);
                uncomfortableProb += (hotProb > 50 || coldProb > 50) ? 10 : 0;
                
                // Aseguramos que no superen 100%
                return {
                    hot: Math.min(hotProb, 95),
                    cold: Math.min(coldProb, 95),
                    windy: Math.min(windyProb, 95),
                    humid: Math.min(humidProb, 95),
                    uncomfortable: Math.min(uncomfortableProb, 95),
                    actualData: weatherData
                };
            }
            
            // Funci√≥n para actualizar las barras de probabilidad
            function updateProbabilityBars(probabilities) {
                // Animamos las barras de probabilidad
                setTimeout(() => {
                    document.getElementById('hot-probability').style.width = probabilities.hot + '%';
                    document.getElementById('cold-probability').style.width = probabilities.cold + '%';
                    document.getElementById('windy-probability').style.width = probabilities.windy + '%';
                    document.getElementById('humid-probability').style.width = probabilities.humid + '%';
                    document.getElementById('uncomfortable-probability').style.width = probabilities.uncomfortable + '%';
                    
                    // Actualizamos los textos
                    document.getElementById('hot-text').textContent = Math.round(probabilities.hot) + '%';
                    document.getElementById('cold-text').textContent = Math.round(probabilities.cold) + '%';
                    document.getElementById('windy-text').textContent = Math.round(probabilities.windy) + '%';
                    document.getElementById('humid-text').textContent = Math.round(probabilities.humid) + '%';
                    document.getElementById('uncomfortable-text').textContent = Math.round(probabilities.uncomfortable) + '%';
                }, 100);
            }
            
            // Evento del bot√≥n de consulta
            consultBtn.addEventListener('click', function() {
                const location = locationInput.value.trim();
                const datetime = datetimeInput.value;
                
                if (!location || location === "Selecciona un lugar en el mapa") {
                    alert('Por favor, selecciona una ubicaci√≥n en el mapa.');
                    return;
                }
                
                if (!datetime) {
                    alert('Por favor, selecciona una fecha y hora.');
                    return;
                }
                
                if (!currentLocationData) {
                    alert('Por favor, selecciona una ubicaci√≥n v√°lida en el mapa.');
                    return;
                }
                
                // Agregar mensaje del usuario
                addMessage(`Consulta para: ${location} - ${new Date(datetime).toLocaleString()}`, true);
                
                // Mostrar mensaje de procesamiento
                const processingMsg = addMessage('Obteniendo datos meteorol√≥gicos en tiempo real...');
                
                // Obtener datos meteorol√≥gicos
                fetchWeatherData(currentLocationData.coords[0], currentLocationData.coords[1], datetime)
                    .then(weatherData => {
                        // Remover mensaje de procesamiento
                        chatContainer.removeChild(processingMsg);
                        
                        // Calcular probabilidades basadas en datos reales
                        const probabilities = calculateProbabilities(weatherData, datetime);
                        
                        // Mostrar resultados
                        addMessage(`He analizado las condiciones para ${location} en la fecha seleccionada. A continuaci√≥n te muestro las probabilidades de condiciones extremas basadas en datos meteorol√≥gicos actuales:`);
                        
                        // Mostrar datos actuales
                        addMessage(`üìä Datos actuales: Temperatura: ${weatherData.temperature.toFixed(1)}¬∞C, Humedad: ${weatherData.humidity.toFixed(0)}%, Viento: ${weatherData.windSpeed.toFixed(1)} km/h, Sensaci√≥n t√©rmica: ${weatherData.feelsLike.toFixed(1)}¬∞C`);
                        
                        // Mostrar secci√≥n de resultados
                        resultsDiv.style.display = 'block';
                        
                        // Actualizar barras de probabilidad
                        updateProbabilityBars(probabilities);
                        
                        // Actualizar fuente de datos
                        dataSource.textContent = `Fuente: Datos meteorol√≥gicos en tiempo real (${new Date().toLocaleTimeString()})`;
                        
                        // Generar recomendaciones basadas en las probabilidades
                        generateRecommendations(location, probabilities, datetime, weatherData);
                    })
                    .catch(error => {
                        // Remover mensaje de procesamiento
                        chatContainer.removeChild(processingMsg);
                        
                        // Mostrar mensaje de error
                        addMessage('‚ùå Error al obtener datos meteorol√≥gicos. Por favor, intenta nuevamente.');
                        console.error('Error:', error);
                    });
            });
            
            // Funci√≥n para generar recomendaciones basadas en las probabilidades
            function generateRecommendations(location, probabilities, datetime, weatherData) {
                let recommendations = "";
                const date = new Date(datetime);
                
                // Generar recomendaciones basadas en las condiciones
                if (probabilities.hot > 60) {
                    recommendations += "‚Ä¢ Se esperan temperaturas muy elevadas. Evita la exposici√≥n directa al sol entre las 12:00 y 16:00 horas. ";
                    recommendations += "‚Ä¢ Usa ropa ligera y de colores claros, y no olvides el protector solar. ";
                    recommendations += "‚Ä¢ Mantente bien hidratado, bebiendo al menos 2 litros de agua al d√≠a. ";
                }
                
                if (probabilities.cold > 60) {
                    recommendations += "‚Ä¢ Se esperan temperaturas muy bajas. Abr√≠gate con varias capas de ropa. ";
                    recommendations += "‚Ä¢ Protege especialmente las extremidades (manos, pies y cabeza). ";
                    recommendations += "‚Ä¢ Ten cuidado con las superficies heladas que puedan ser resbaladizas. ";
                }
                
                if (probabilities.windy > 60) {
                    recommendations += "‚Ä¢ Se esperan vientos fuertes. Evita actividades al aire libre que puedan ser peligrosas. ";
                    recommendations += "‚Ä¢ Ten cuidado con objetos que puedan ser arrastrados por el viento. ";
                    recommendations += "‚Ä¢ Si conduces, mant√©n ambas manos en el volante, especialmente en carreteras expuestas. ";
                }
                
                if (probabilities.humid > 60) {
                    recommendations += "‚Ä¢ Se espera alta humedad. La sensaci√≥n t√©rmica puede ser mayor que la temperatura real. ";
                    recommendations += "‚Ä¢ Usa ropa de tejidos naturales que permitan la transpiraci√≥n. ";
                    recommendations += "‚Ä¢ Considera usar un deshumidificador si est√°s en espacios cerrados. ";
                }
                
                if (probabilities.uncomfortable > 60) {
                    recommendations += "‚Ä¢ Las condiciones generales ser√°n muy inc√≥modas. Planifica actividades en interiores si es posible. ";
                    recommendations += "‚Ä¢ Si debes salir, lleva contigo todo lo necesario para protegerte (agua, protector solar, sombrilla, etc.). ";
                }
                
                // Si ninguna probabilidad es muy alta, dar recomendaciones generales
                if (probabilities.hot < 40 && probabilities.cold < 40 && 
                    probabilities.windy < 40 && probabilities.humid < 40 && 
                    probabilities.uncomfortable < 40) {
                    recommendations = "Las condiciones meteorol√≥gicas ser√°n generalmente favorables. Aprovecha para realizar actividades al aire libre, pero mantente atento a cualquier cambio en el clima.";
                }
                
                // A√±adir recomendaci√≥n final
                recommendations += " Estas recomendaciones se basan en datos meteorol√≥gicos actuales y pueden cambiar. Consulta el pron√≥stico actualizado antes de salir.";
                
                addMessage("üìã Recomendaciones basadas en el an√°lisis: " + recommendations);
                
                // Mostrar informaci√≥n adicional sobre la ubicaci√≥n
                if (locationData[location]) {
                    addMessage("üí° " + locationData[location].characteristics.substring(0, 150) + "...");
                }
            }
            
            // Seleccionar Madrid por defecto
            selectLocation('Madrid, Espa√±a', locationData['Madrid, Espa√±a']);
        });
    </script>
</body>
</html>